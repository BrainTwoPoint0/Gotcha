// prisma/schema.prisma

generator client {
  provider      = "prisma-client-js"
  output        = "../node_modules/.prisma/client"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

// ============================================
// ORGANIZATION & AUTH
// ============================================

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  members      OrganizationMember[]
  projects     Project[]
  subscription Subscription?

  @@index([slug])
}

model OrganizationMember {
  id             String     @id @default(cuid())
  organizationId String
  userId         String
  role           MemberRole @default(MEMBER)
  createdAt      DateTime   @default(now())

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([userId])
}

enum MemberRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  avatarUrl String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Profile fields (onboarding)
  companySize String?   // "solo" | "2-10" | "11-50" | "50+"
  role        String?   // "founder" | "engineer" | "pm" | "designer" | "other"
  industry    String?   // "saas" | "ecommerce" | "education" | "healthcare" | "agency" | "other"
  useCase     String?   // "user-feedback" | "feature-validation" | "bug-reports" | "nps" | "polls" | "other"
  onboardedAt DateTime? // Set when user completes or skips onboarding

  // Relations
  memberships OrganizationMember[]

  @@index([email])
}

// ============================================
// PROJECTS & API KEYS
// ============================================

model Project {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  slug           String
  description    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Settings
  settings Json @default("{}")

  // Relations
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  apiKeys        ApiKey[]
  elements       Element[]
  responses      Response[]
  experiments    Experiment[]
  metadataFields MetadataField[]

  @@unique([organizationId, slug])
  @@index([organizationId])
}

model ApiKey {
  id             String    @id @default(cuid())
  projectId      String
  name           String // e.g., "Production", "Development"
  key            String    @unique // gtch_live_xxx or gtch_test_xxx
  keyHash        String // For secure lookup
  allowedDomains String[] // ["*.myapp.com", "localhost:*"] for origin validation
  lastUsedAt     DateTime?
  createdAt      DateTime  @default(now())
  revokedAt      DateTime?

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([keyHash])
  @@index([projectId])
}

// ============================================
// ELEMENTS & FEEDBACK
// ============================================

model Element {
  id          String   @id @default(cuid())
  projectId   String
  elementId   String // Developer-provided identifier
  name        String? // Optional friendly name
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  project   Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  responses Response[]

  @@unique([projectId, elementId])
  @@index([projectId])
}

model Response {
  id           String       @id @default(cuid())
  projectId    String
  elementId    String? // FK to Element
  elementIdRaw String // Original elementId string (for unregistered elements)

  // Response data
  mode    ResponseMode
  content String? // Text feedback or feature request description
  title   String? // For feature requests
  rating  Int? // 1-5 or 1-10
  vote    VoteType? // For vote mode

  // Poll specific
  pollOptions  Json? // Array of options that were presented
  pollSelected Json? // Array of selected option(s) - indexes or values

  // A/B specific
  experimentId String?
  variant      String?

  // User data (flexible JSON for arbitrary metadata)
  endUserId   String? // The ID passed by developer
  endUserMeta Json    @default("{}")

  // Context
  url       String? // Page URL where feedback was given
  userAgent String?

  // Idempotency
  idempotencyKey String?

  // Plan gating â€” true when response was collected beyond the monthly free limit
  gated Boolean @default(false)

  // Timestamps
  createdAt DateTime @default(now())

  // Relations
  project    Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  element    Element?    @relation(fields: [elementId], references: [id], onDelete: SetNull)
  experiment Experiment? @relation(fields: [experimentId], references: [id], onDelete: SetNull)

  // Note: Unique constraint on [projectId, elementIdRaw, endUserId] not used
  // because existing data has duplicates. Edit checks handled in application layer.
  @@index([projectId])
  @@index([elementId])
  @@index([projectId, elementIdRaw])
  @@index([experimentId])
  @@index([createdAt])
  @@index([endUserId])
  @@index([idempotencyKey])
}

enum ResponseMode {
  FEEDBACK
  VOTE
  POLL
  FEATURE_REQUEST
  AB
}

enum VoteType {
  UP
  DOWN
}

// ============================================
// A/B EXPERIMENTS
// ============================================

model Experiment {
  id           String           @id @default(cuid())
  projectId    String
  experimentId String // Developer-provided identifier
  name         String
  description  String?
  variants     Json // Array of variant names
  status       ExperimentStatus @default(DRAFT)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  startedAt    DateTime?
  endedAt      DateTime?

  // Relations
  project   Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  responses Response[]

  @@unique([projectId, experimentId])
  @@index([projectId])
}

enum ExperimentStatus {
  DRAFT
  RUNNING
  PAUSED
  COMPLETED
}

// ============================================
// METADATA FIELDS
// ============================================

model MetadataField {
  id          String   @id @default(cuid())
  projectId   String
  fieldKey    String   // e.g., "age", "location", "plan"
  displayName String?  // e.g., "Age Group", "Country"
  fieldType   String   @default("string") // "string" | "number" | "boolean"
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, fieldKey])
  @@index([projectId])
}

// ============================================
// BILLING
// ============================================

model Subscription {
  id               String    @id @default(cuid())
  organizationId   String    @unique
  stripeCustomerId String?
  stripePriceId    String?
  stripeSubId      String?
  plan             Plan      @default(FREE)
  status           SubStatus @default(ACTIVE)
  currentPeriodEnd DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Usage tracking
  responsesThisMonth Int       @default(0)
  responsesResetAt   DateTime?

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([stripeCustomerId])
}

// Only FREE and PRO are actively used. STARTER and ENTERPRISE are retained
// to avoid a migration that would break existing rows referencing them.
enum Plan {
  FREE
  STARTER
  PRO
  ENTERPRISE
}

enum SubStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  TRIALING
}
